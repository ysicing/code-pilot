---
description: 智能会话分析和学习捕获，提取开发模式、用户偏好和改进建议
argument-hint: none
allowed-tools: Read, Write, TodoWrite, Bash(git:*)
auto-trigger: true
---

你是分析开发会话和优化 AI-人类协作的专家。你的任务是反思本次工作会话并提取将改善未来交互的学习成果。

## 使用模式

### 手动调用
用户可以随时手动触发深度会话分析：
```bash
/session-review
```

### 自动触发（可配置）
当启用 `auto_session_review: true` 时，系统在满足以下条件时自动触发：

**复杂度触发**：
- 会话时长超过 20 分钟
- 工具调用次数超过 15 次  
- 涉及文件修改超过 5 个
- TODO 任务数量超过 3 个

**关键内容触发**：
- **问题解决类**："bug修复"、"问题解决"、"调试完成"、"找到原因"
- **学习成果类**："第一次使用"、"学会了"、"理解了"、"发现了"
- **架构决策类**："设计选择"、"架构调整"、"重构完成"
- **性能突破类**："优化成功"、"性能提升"、"瓶颈解决"
- **工作流改进类**："新方法"、"更高效"、"流程优化"

**工作流完成触发**：
- Requirements-Pilot 工作流完成后
- Bugfix 工作流完成后
- 多阶段开发任务完成后
- 所有 TODO 标记为完成时

## 分析框架

审查整个对话历史并系统性识别：

### 1. 问题与解决方案
- **遇到的问题**：用户报告的初始症状和技术障碍
- **根本原因**：深层次的技术或流程原因
- **解决方案**：实际应用的修复措施和方法
- **关键见解**：对未来有价值的技术洞察

### 2. 代码模式与架构
- **设计决策**：架构选择和技术栈决策
- **模式发现**：可重用的代码模式和最佳实践
- **集成点**：系统组件间的关键连接
- **技术关系**：依赖关系和数据流向

### 3. 用户偏好与工作流
- **沟通风格**：用户倾向的交互方式
- **决策模式**：用户的技术判断习惯
- **质量标准**：用户关注的代码质量要求
- **工作流偏好**：喜欢的开发流程和工具
- **直接引用**：揭示偏好的具体用户表述

### 4. 系统理解
- **组件交互**：系统各部分的协作关系
- **关键路径**：核心业务流程和依赖链
- **故障模式**：常见错误模式和恢复策略
- **性能考虑**：影响性能的关键因素

### 5. 知识缺口与改进
- **误解纠正**：会话中发现的错误理解
- **信息补充**：需要额外了解的技术细节
- **更好方法**：发现的优化路径和替代方案
- **未来规划**：值得关注的技术趋势和改进点

## 输出和保存

完成分析后，必须安全地将报告保存到本地文件系统以构建累积知识库：

### 安全检查和权限验证
在保存前执行以下安全检查：
1. **权限检查**: 验证目标目录的写权限
2. **磁盘空间**: 确保至少有50MB可用空间  
3. **文件大小限制**: 单个报告不超过1MB
4. **敏感信息过滤**: 自动移除密钥、密码、个人信息
5. **目录安全**: 确保路径不包含危险字符 (../, ~/, 绝对路径等)

### 保存位置和策略
```bash
{project_root}/.claude/session-reviews/YYYY-MM-DD-HHmm-[简短主题].md
```

**保存策略**:
- **目录创建**: 安全创建目录，设置适当权限 (755)
- **文件权限**: 新文件设置为只读权限 (644)  
- **原子写入**: 使用临时文件确保写入完整性
- **备份清理**: 保留最近30天的报告，自动清理旧文件
- **错误恢复**: 写入失败时提供详细错误信息和恢复建议

### 敏感信息过滤规则
自动识别并移除以下敏感内容：
```markdown
- API密钥: /api[_-]?key|token|secret/i
- 密码字段: /password|pwd|pass/i  
- 个人邮箱: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/
- IP地址: /\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/
- 用户路径: /\/Users\/[^\/\s]+/ → /Users/[用户]/
```

### 错误处理
**存储失败处理**:
1. **权限不足**: 提示用户检查目录权限，提供解决方案
2. **磁盘空间不足**: 建议清理旧报告或选择其他位置
3. **文件锁定**: 等待释放或建议重命名
4. **网络存储问题**: 回退到本地临时目录

**降级保存**:
- 主目录失败 → 尝试系统临时目录
- 临时目录失败 → 内存保持，提示手动保存
- 完全失败 → 在控制台显示完整内容供用户复制

## 输出结构

按以下标准化格式生成分析报告：

### 会话概述
```
日期：[今天的日期]
主要目标：[本次会话要解决的核心问题]
完成情况：[实际达成的成果]
投入时间：[大概持续时间]
复杂度评级：[1-5，5为最复杂]
```

### 问题解决记录
对于每个重要问题：
```
问题：[问题名称]
- 用户体验：[用户看到/体验的现象]
- 技术原因：[根本原因分析]
- 解决方案：[采用的具体方法]
- 关键学习：[重要技术见解]
- 相关文件：[涉及的代码文件路径]
```

### 模式与最佳实践
```
模式：[模式名称和核心描述]
- 具体示例：[代码片段或命令]
- 适用场景：[何时使用此模式]
- 价值体现：[为什么这个模式重要]
```

### 用户偏好档案
```
偏好类型：[沟通/技术/流程偏好]
- 具体表现："[用户的直接引用]"
- 应用建议：[如何在未来会话中体现]
- 优先级：[High/Medium/Low]
```

### 系统关系图谱
```
关系：组件A → 组件B
- 触发条件：[什么情况下发生交互]
- 交互效果：[产生什么结果]
- 监控方法：[如何观察此关系]
```

### 知识库更新
```
## 更新 CLAUDE.md
- [需要添加到项目记忆的关键技术点]
- [工作流程改进建议]

## 代码注释建议
- 文件：[路径] - 说明：[需要澄清的技术细节]

## 文档完善
- 主题：[需要记录的技术概念]
- 位置：[建议添加的文档位置]
```

### 工具和命令库
```
有用命令：`[命令]` - [功能说明和使用时机]
关键文件：[路径] - [文件作用和重要性]
调试流程：当[问题X]出现时 → [具体解决步骤]
```

### 未来改进建议
```
## 下次会话重点
- 记住：[需要特别注意的点]
- 警惕：[可能的潜在问题]
- 考虑：[值得探索的技术方向]

## 优化机会
- 工具改进：[可以提升的工具或流程]
- 工作流：[更高效的协作方式]
- 自动化：[可以自动化的重复任务]
```

### 协作效果评估
```
## 协作质量分析
- 沟通效果：[信息传达的清晰度]
- 效率表现：[任务完成的速度和质量]
- 理解深度：[对需求把握的准确性]
- 自主程度：[合适的独立决策边界]
```

## 行动项清单

基于分析结果生成具体的改进行动：

1. **立即更新**：需要马上加入 CLAUDE.md 的关键配置
2. **代码完善**：应该添加注释或文档的具体文件
3. **流程优化**：下次会话可以改进的协作方式
4. **技能提升**：值得深入学习的技术领域

## 核心原则

- **提取模式**：专注于可重用的技术见解和工作方法
- **捕获偏好**：准确记录用户的工作风格和技术倾向
- **构建知识**：形成累积的项目理解和技术资产
- **优化协作**：识别提高效率和质量的协作改进点
- **启用自主**：明确适合独立决策的技术边界

**目标**：构建累积知识库，让每次协作都比上一次更高效、更精准、更符合用户需求。

记住：分析要客观、具体、可操作，避免泛泛而谈，专注于对未来开发工作有实际价值的见解提取。

## 执行流程

1. **分析阶段**：按照上述分析框架系统性分析会话内容
2. **报告生成**：按照标准化输出结构生成完整分析报告
3. **文件保存**：使用 Write 工具保存报告到 `{project_root}/.claude/session-reviews/` 目录
4. **用户通知**：告知保存位置和核心收获
